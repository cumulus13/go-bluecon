name: Build and Release Multi-Platform Binaries

on:
  release:
    types: [published, created]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
          
      - name: Get version
        id: version
        run: |
          VERSION=""
          
          # Tag push event
          if [[ -n "$GITHUB_REF" && "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          
          # Release event
          elif [[ "$GITHUB_EVENT_NAME" == "release" && -n "$GITHUB_EVENT_RELEASE_TAG_NAME" ]]; then
            VERSION="$GITHUB_EVENT_RELEASE_TAG_NAME"
          
          # Workflow dispatch (use latest tag or commit hash)
          elif [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            if git describe --tags --exact-match HEAD 2>/dev/null; then
              VERSION=$(git describe --tags --exact-match HEAD)
            else
              VERSION="dev-$(git rev-parse --short HEAD)"
            fi
          
          # Fallback
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          
          # Strip leading 'v' for cleaner filenames (optional)
          VERSION="${VERSION#v}"
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"
        env:
          GITHUB_EVENT_RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          
      - name: Build
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          echo "Building for $GOOS/$GOARCH"
          
          # Set binary name
          if [ "$GOOS" = "windows" ]; then
            BINARY="bluecon-${{ steps.version.outputs.version }}-$GOOS-$GOARCH.exe"
          else
            BINARY="bluecon-${{ steps.version.outputs.version }}-$GOOS-$GOARCH"
          fi
          
          echo "Binary name: $BINARY"
          
          # Build
          go build -v -trimpath -ldflags="-s -w" -o "$BINARY" ./bluecon
          
          # Verify binary exists
          if [ ! -f "$BINARY" ]; then
            echo "âŒ ERROR: Binary not found: $BINARY"
            exit 1
          fi
          
          ls -lh "$BINARY"
          
          # Generate checksum
          sha256sum "$BINARY" > "$BINARY.sha256"
          cat "$BINARY.sha256"
          
          # Save for artifact upload
          echo "BINARY=$BINARY" >> "$GITHUB_ENV"
          
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bluecon-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            ${{ env.BINARY }}
            ${{ env.BINARY }}.sha256
          if-no-files-found: error
          retention-days: 90

  release:
    name: Create/Update Release
    needs: build
    runs-on: ubuntu-latest
    # FIXED: Proper expression syntax with ${{ }}
    if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get version
        id: version
        run: |
          VERSION=""
          
          if [[ -n "$GITHUB_REF" && "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ "$GITHUB_EVENT_NAME" == "release" && -n "$GITHUB_EVENT_RELEASE_TAG_NAME" ]]; then
            VERSION="$GITHUB_EVENT_RELEASE_TAG_NAME"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"
        env:
          GITHUB_EVENT_RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files
          merge-multiple: true  # CRITICAL: flattens all artifacts into single directory
          
      - name: Verify downloaded files
        run: |
          echo "ðŸ“ Downloaded artifacts:"
          ls -lh release-files/
          
          if [ ! -d release-files ] || [ -z "$(ls -A release-files/ 2>/dev/null)" ]; then
            echo "âŒ ERROR: No artifacts downloaded!"
            exit 1
          fi
          
      - name: Create Release (for tag pushes & workflow_dispatch)
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') || startsWith(steps.version.outputs.version, 'dev-') }}
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload to Existing Release (for release events)
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'release' }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-summary:
    name: Generate Release Summary
    needs: release
    runs-on: ubuntu-latest
    if: ${{ always() }}
    
    steps:
      - name: Create Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
# ðŸŽ‰ Release Build Complete!

## ðŸ“¦ Built Binaries

| Platform | Architecture | Binary Name |
|----------|--------------|-------------|
| ðŸ§ Linux | x86_64 | \`bluecon-${{ needs.release.outputs.version }}-linux-amd64\` |
| ðŸ§ Linux | ARM64 | \`bluecon-${{ needs.release.outputs.version }}-linux-arm64\` |
| ðŸªŸ Windows | x86_64 | \`bluecon-${{ needs.release.outputs.version }}-windows-amd64.exe\` |
| ðŸŽ macOS | Intel | \`bluecon-${{ needs.release.outputs.version }}-darwin-amd64\` |
| ðŸŽ macOS | Apple Silicon | \`bluecon-${{ needs.release.outputs.version }}-darwin-arm64\` |

## âœ… Features

- Static binaries (no dependencies required)
- Alpine Linux compatible
- CGO disabled for maximum portability
- SHA256 checksums included

## ðŸ“¥ Installation

### Linux (Ubuntu, Debian, etc)
\`\`\`bash
# Download
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-linux-amd64

# Make executable
chmod +x bluecon-${{ needs.release.outputs.version }}-linux-amd64

# Move to PATH
sudo mv bluecon-${{ needs.release.outputs.version }}-linux-amd64 /usr/local/bin/bluecon

# Verify
bluecon --version
\`\`\`

### Alpine Linux
\`\`\`bash
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-linux-amd64
chmod +x bluecon-${{ needs.release.outputs.version }}-linux-amd64
mv bluecon-${{ needs.release.outputs.version }}-linux-amd64 /usr/local/bin/bluecon
bluecon --version
\`\`\`

### macOS
\`\`\`bash
# Intel Mac
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-darwin-amd64
chmod +x bluecon-${{ needs.release.outputs.version }}-darwin-amd64
sudo mv bluecon-${{ needs.release.outputs.version }}-darwin-amd64 /usr/local/bin/bluecon

# Apple Silicon (M1/M2/M3)
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-darwin-arm64
chmod +x bluecon-${{ needs.release.outputs.version }}-darwin-arm64
sudo mv bluecon-${{ needs.release.outputs.version }}-darwin-arm64 /usr/local/bin/bluecon

bluecon --version
\`\`\`

### Windows
Download \`bluecon-${{ needs.release.outputs.version }}-windows-amd64.exe\` from the [releases page](https://github.com/${{ github.repository }}/releases/latest) and run directly.

## ðŸ” Verify Checksums

\`\`\`bash
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-linux-amd64
wget https://github.com/${{ github.repository }}/releases/latest/download/bluecon-${{ needs.release.outputs.version }}-linux-amd64.sha256
sha256sum -c bluecon-${{ needs.release.outputs.version }}-linux-amd64.sha256
# Expected: bluecon-${{ needs.release.outputs.version }}-linux-amd64: OK
\`\`\`
EOF